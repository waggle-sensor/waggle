<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Waggle: /home/theone/repos/waggle/nodecontroller/nc-wag-os/waggled/DataCache/Data_Cache.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../..//Img/doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Waggle
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Data__Cache_8py_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Data_Cache.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="Data__Cache_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html">    1</a></span>&#160;<span class="comment">#!/usr/bin/env python</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Queue</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#from daemon import Daemon</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> sys, os, os.path, time, atexit, socket, datetime, argparse</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;sys.path.append(<span class="stringliteral">&#39;../../../&#39;</span>)</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacewaggle__protocol_1_1protocol_1_1PacketHandler.html">waggle_protocol.protocol.PacketHandler</a> <span class="keyword">import</span> *</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;sys.path.append(<span class="stringliteral">&#39;../NC/&#39;</span>)</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">from</span> NC_configuration <span class="keyword">import</span> *</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;sys.path.append(<span class="stringliteral">&#39;../NC/&#39;</span>)</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> msg_handler <span class="keyword">import</span> msg_handler</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> glob <span class="keyword">import</span> glob</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> logging, logging.handlers</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">import</span> signal</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">from</span> waggle_protocol.utilities.pidfile <span class="keyword">import</span> PidFile, AlreadyRunning</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="stringliteral">    The Data Cache stores messages between the nodes and the cloud. The main function is a unix socket server. The internal and external facing communication classes connect to</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="stringliteral">    the data cache to push or pull messages. The data cache consists of two buffers, which are matrixes of queues. Each queue cooresponds to a device location and message priority within the matrix.</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="stringliteral">    The data cache stores messages in the queues until the available memory runs out. When the number of messages exceeds the available memory, the messages queues are cleared and the messages are written to a file.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">#TODO make improvements. Suggestions for improvements are written as TODOs</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a5e5ea3ed7ef248c2c1df51a59df2ea20">   29</a></span>&#160;loglevel=logging.DEBUG</div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#aea71f6239ec2b244213db338221ca599">   30</a></span>&#160;LOG_FILENAME=<span class="stringliteral">&quot;/var/log/waggle/data_cache_logging.log&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a4804c78450c5b194d401d3a85353fe75">   31</a></span>&#160;LOG_FORMAT=<span class="stringliteral">&#39;%(asctime)s - %(name)s - %(levelname)s - line=%(lineno)d - %(message)s&#39;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#ac38de2c272602555dbbf0a4c53b05a21">   32</a></span>&#160;pid_file = <span class="stringliteral">&quot;/var/run/waggle/data_cache.pid&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#af34519f563ff83e4f318074859fc470f">   34</a></span>&#160;logger = logging.getLogger(__name__)</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;logger.setLevel(loglevel)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a4dbac51718da313bbf7079195333d6dc">   39</a></span>&#160;root_logger = logging.getLogger()</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;root_logger.setLevel(loglevel)</div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a3199037f38b7b3df94103714b6d1af4d">   41</a></span>&#160;formatter = logging.Formatter(LOG_FORMAT)</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#ab4806e3e8feb001760470411c2e3515d">   43</a></span>&#160;handler = logging.StreamHandler(stream=sys.stdout)</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;handler.setFormatter(formatter)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;root_logger.handlers = []</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;root_logger.addHandler(handler)</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#aec067f5b293ab8a5d05f9a780f39eddb">   49</a></span>&#160;dc = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;   <span class="comment">#dummy variables. These buffers are created when the data cache starts.</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a5f3685394504e82241020cf3312dc4a1">   53</a></span>&#160;stop_process = <span class="keyword">False</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a8c7eb271c63236a96891baf73a81a4b4">   59</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceData__Cache.html#a8c7eb271c63236a96891baf73a81a4b4">signal_term_handler</a>(signal, frame):</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    logger.debug(<span class="stringliteral">&#39;got SIGTERM&#39;</span>)</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> dc:</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        logger.debug(<span class="stringliteral">&#39;execute dc.stop()&#39;</span>)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        dc.stop()</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment"># Can&#39;t exit here, the flush fiunction has to exit using variable &quot;stop_process&quot;</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">#sys.exit(0)</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"># this would interrupt IO. Need to run everything in separate thread/process</span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#ac38c6d21a594205fe16a2de3c86f72fc">   69</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceData__Cache.html#ac38c6d21a594205fe16a2de3c86f72fc">signal_info_handler</a>(signal, frame):</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    logger.debug(<span class="stringliteral">&#39;got SIGUSR1&#39;</span>)</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="comment">#print &quot;status: &quot;, str(dc.get_status())</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;signal.signal(signal.SIGTERM, signal_term_handler)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">#signal.signal(signal.SIGUSR1, signal_info_handler)</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html">   81</a></span>&#160;<span class="keyword">class </span><a class="code" href="classData__Cache_1_1DataCache.html">DataCache</a>:</div>
<div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#aedd2bb179af3b189e4ecf0636e680f61">   82</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#aedd2bb179af3b189e4ecf0636e680f61">__init__</a>(self):</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">#self.data = []</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">   85</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a> = <span class="stringliteral">&#39;/tmp/Data_Cache_server&#39;</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">   87</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">incoming_bffr</a> = []</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">   89</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">outgoing_bffr</a> = []</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">   91</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> = 0 <span class="comment">#value that indicates if the DC is flushing or not</span></div>
<div class="line"><a name="l00092"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">   92</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> = 0 <span class="comment">#keeps track of total messages in queues</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="comment">#If the data cache flushed messages to files, this stores the the current outgoing file that messages are being read from</span></div>
<div class="line"><a name="l00094"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">   94</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">outgoing_cur_file</a> = <span class="stringliteral">&#39;&#39;</span> <span class="comment">#empty string if there are no files</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="comment">#If the data cache flushed messages to files, this stores a list of current files for each device</span></div>
<div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">   96</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a> =  [<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>] <span class="comment">#empty string if there are no files</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">   98</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">outgoing_available_queues</a> = list()</div>
<div class="line"><a name="l00099"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a8061a8b3a8db64ba0bfb88274d8d259e">   99</a></span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a8061a8b3a8db64ba0bfb88274d8d259e">incoming_available_queues</a> = list()</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#abbaab48d9fe727111a2835b2c71fad35">  101</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#abbaab48d9fe727111a2835b2c71fad35">run</a>(self):</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        logger.info(<span class="stringliteral">&quot;Starting DataCache...&quot;</span>)</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="comment">#Each buffer is a matrix of queues for organization and indexing purposes.</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="comment">#make incoming buffer</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">incoming_bffr</a> = self.<a class="code" href="classData__Cache_1_1DataCache.html#ab3eba25936f842529523447d070aa2e2">make_bffr</a>(len(PRIORITY_ORDER))</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="comment">#make outgoing buffer</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">outgoing_bffr</a> = self.<a class="code" href="classData__Cache_1_1DataCache.html#ab3eba25936f842529523447d070aa2e2">make_bffr</a>(len(PRIORITY_ORDER))</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="comment">#the main server loop</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <span class="comment">#indicates that the server is flushing the buffers. Shuts down the server until the all queues have been written to a file</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="keywordflow">while</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> ==1:</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                logger.debug(<span class="stringliteral">&quot;Cache is in flush state&quot;</span>)</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                time.sleep(1)</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            <span class="keywordflow">if</span> os.path.exists(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>): <span class="comment">#checking for the file</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                os.remove(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>)</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            logger.debug(<span class="stringliteral">&quot;Opening server socket...&quot;</span>)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            <span class="comment">#creates a UNIX, STREAMing socket</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            server_sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) <span class="comment"># TODO should this not be a class variable ?</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            server_sock.bind(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>) <span class="comment">#binds to this file path</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="comment">#become a server socket and start listening for clients</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            server_sock.listen(6)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a>==1: <span class="comment">#shuts down the server until the all queues have been written to a file</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                    logger.debug(<span class="stringliteral">&#39;Server flush!&#39;</span>)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                    server_sock.close()</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                    os.remove(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                    logger.debug(<span class="stringliteral">&#39;Server flush closed socket&#39;</span>)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                    <span class="keywordflow">break</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                <span class="comment">#accept connections from outside</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                    client_sock, address = server_sock.accept()</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                <span class="keywordflow">except</span> KeyboardInterrupt:</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                    logger.info(<span class="stringliteral">&quot;Shutdown requested...exiting&quot;</span>)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">stop</a>()</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                    sys.exit(0)</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                    logger.info(<span class="stringliteral">&quot;server_sock.accept: &quot;</span>+str(e))</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">stop</a>()</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                    sys.exit(1)</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                    data = client_sock.recv(2048) <span class="comment">#arbitrary</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                    <span class="keywordflow">if</span> logger.isEnabledFor(logging.DEBUG):</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                        <span class="keywordflow">if</span> data != <span class="stringliteral">&#39;|o&#39;</span>:</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                            logger.debug(<span class="stringliteral">&#39;(DataCache) received data.&#39;</span>)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> data:</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                        <span class="keywordflow">break</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                        <span class="comment">#&#39;Flush&#39; means that there is an external flush request or if WagMan is about to shut down the node controller</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                        <span class="keywordflow">if</span> data == <span class="stringliteral">&#39;Flush&#39;</span>:</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                            <span class="comment">#flush all stored messages into files</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                            logger.debug(<span class="stringliteral">&#39;External flush request made.&#39;</span>)</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                            self.<a class="code" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">DC_flush</a>()</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                            <span class="keywordflow">if</span> stop_process:</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                                logger.info(<span class="stringliteral">&quot;DC has been flushed. Process will stop now.&quot;</span>)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                                sys.exit(0)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                        <span class="comment">#Indicates that it is a pull request ( somebody want data from the DC)</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                        <span class="keywordflow">elif</span> data[0] == <span class="stringliteral">&#39;|&#39;</span>: <span class="comment">#TODO This could be improved if there is a better way to distinguish between push and pull requests and from incoming and outgoing requests</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                            logger.debug(<span class="stringliteral">&#39;Somebody wants data&#39;</span>)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                            data, dest = data.split(<span class="stringliteral">&#39;|&#39;</span>, 1) <span class="comment">#splits to get either &#39;o&#39; for outgoing request or the device location for incoming request</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                            <span class="keywordflow">if</span> dest != <span class="stringliteral">&#39;o&#39;</span>:</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                                logger.debug(<span class="stringliteral">&#39;Somebody wants data, without o&#39;</span>)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                                msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a1a83f7f61f7bee466fd265ef574823d3">incoming_pull</a>(int(dest)) <span class="comment">#pulls a message from that device&#39;s queue</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                                <span class="keywordflow">if</span> <span class="keywordflow">not</span> msg:</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                                    logger.debug(<span class="stringliteral">&quot;no message&quot;</span>)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                                    msg = <span class="stringliteral">&#39;False&#39;</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                                    logger.debug(<span class="stringliteral">&quot;incoming_pull message: %s&quot;</span> %(msg))</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                                    client_sock.sendall(msg) <span class="comment">#sends the message</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                                <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                                    <span class="comment">#pushes it back into the incoming queue if the client disconnects before the message is sent</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                                    <span class="keywordflow">try</span>: <span class="comment">#Will pass if data is a pull request instead of a full message</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                                        <span class="comment">#TODO default msg_p is 5 for messages pushed back into queue. Improvement recommended.</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                                        <a class="code" href="classData__Cache_1_1DataCache.html#a65d6cda8ffbc13098cfda3b1046d38cc">incoming_push</a>(int(dest),5, msg)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                                    <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                                        <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                                logger.debug(<span class="stringliteral">&#39;Somebody wants data, using o&#39;</span>)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                                msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a4802f5d86a8b865bd8523cff8d14bb21">outgoing_pull</a>() <span class="comment">#pulls the highest priority message</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                                <span class="keywordflow">if</span> <span class="keywordflow">not</span> msg:</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                                    msg = <span class="stringliteral">&#39;False&#39;</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                                    logger.debug(<span class="stringliteral">&quot;have no message for external_client_pull&quot;</span>)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                                    logger.debug(<span class="stringliteral">&quot;sending message to external_client_pull, length %d&quot;</span> % (len(msg)))</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                                    client_sock.sendall(msg) <span class="comment">#sends the message</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                                <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                                    logger.error(<span class="stringliteral">&quot;client_sock.sendall: &quot;</span>+str(e))</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                                    <span class="comment">#pushes it back into the outgoing queue if the client disconnects before the message is sent</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                                    <span class="keywordflow">try</span>:<span class="comment">#Will pass if data is a pull request instead of a full message</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                                        <span class="comment">#TODO default msg_p is 5 for messages pushed back into queue. Improvement recommended.</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                                        self.<a class="code" href="classData__Cache_1_1DataCache.html#a841f2c94321049f5743d7b9627dc6a2a">outgoing_push</a>(int(dest),5,msg)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                                    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                                        logger.error(<span class="stringliteral">&quot;outgoing_push: &quot;</span>+str(e))</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                                        <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                            <span class="comment"># somebody sends data to the DataCache</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                            <span class="comment">#logger.debug(&quot;datacache got: \&quot;&quot;+str(data)+&quot;\&quot;&quot;)</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                            logger.debug(<span class="stringliteral">&#39;Somebody sends data&#39;</span>)</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                                header = get_header(data) <span class="comment">#uses the packet handler function get_header to unpack the header data from the message</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                                flags = header[<span class="stringliteral">&#39;flags&#39;</span>] <span class="comment">#extracts priorities</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                                order = flags[2] <span class="comment">#lifo or fifo</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                                msg_p = flags[1]</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                                recipient_int = header[<span class="stringliteral">&#39;r_uniqid&#39;</span>] <span class="comment">#gets the recipient ID</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                                sender_int = header[<span class="stringliteral">&#39;s_uniqid&#39;</span>]</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                                logger.debug(<span class="stringliteral">&quot;sender_int: %s recipient_int: %s&quot;</span> % (sender_int, recipient_int))</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                                sender = nodeid_int2hexstr(sender_int)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                                recipient = nodeid_int2hexstr(recipient_int)</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                                logger.debug(<span class="stringliteral">&quot;sender: %s recipient: %s NODE_ID: %s&quot;</span> % (sender, recipient, NODE_ID))</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2): <span class="comment">#loops in case device dictionary is not up-to-date</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                                    <span class="comment"># message for the cloud</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                    <span class="keywordflow">if</span> recipient_int == 0: <span class="comment">#0 is the default ID for the cloud. Indicates an outgoing push.</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                                        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                            dev_loc = DEVICE_DICT[sender] <span class="comment">#looks up the location of the sender device (&quot;location&quot; refers to priority!)</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                                        <span class="keywordflow">except</span> KeyError <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                                            logger.error(<span class="stringliteral">&quot;Rejecting message. Sender %s is unknown: %s&quot;</span> % ( sender, str(e)) )</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                                            <span class="keywordflow">continue</span>  <span class="comment"># do not send message from unknown sender</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                                        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                            <span class="keywordflow">if</span> order==<span class="keyword">False</span>: <span class="comment">#indicates lifo. lifo has highest message priority</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                                                msg_p=5</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                                            <span class="comment">#pushes the message into the outgoing buffer to the queue corresponding to the device location and message priority</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                                            self.<a class="code" href="classData__Cache_1_1DataCache.html#a841f2c94321049f5743d7b9627dc6a2a">outgoing_push</a>(int(dev_loc), msg_p, data)</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                                            <span class="comment">#If the device is registered and the push is successful, no need to try again, break the loop</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                                            <span class="keywordflow">break</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                                        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                            logger.error(<span class="stringliteral">&quot;outgoing_push2: &quot;</span>+str(e))</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                                            <span class="comment">#The device dictionary may not be up to date. Need to update and try again.</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                                            <span class="comment">#If the device is still not found after first try, move on.</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                                            update_dev_dict() <span class="comment">#this function is in NC_configuration.py</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                    <span class="comment">#indicates an incoming push</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                    <span class="comment"># message for the nodecontroller</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                                    <span class="keywordflow">elif</span> recipient == NODE_ID <span class="keywordflow">or</span> recipient_int == 1:</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                                        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                                            <span class="comment">#An error will occur if a guestnode registers and then tries to deregister before the device dictionary has been updated</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                                            <span class="comment">#This may be unlikely but is still possible</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                                            <span class="comment">#If that occurs, need to update the device dictionary and try again</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                                            <a class="code" href="namespacemsg__handler.html">msg_handler</a>(data,DEVICE_DICT)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                                            <span class="keywordflow">break</span> <span class="comment">#break the loop if this is successful</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                            logger.error(e)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                            update_dev_dict()</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                                    <span class="comment"># message for a guestnode ?</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                                    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                                        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                                            dev_loc = DEVICE_DICT[recipient] <span class="comment">#looks up the location of the recipient device</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                            <span class="comment">#If the device is registered and the push is successful, no need to try again, break the loop</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                            self.<a class="code" href="classData__Cache_1_1DataCache.html#a65d6cda8ffbc13098cfda3b1046d38cc">incoming_push</a>(int(dev_loc),msg_p,data)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                                            <span class="keywordflow">break</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                                        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                                            <span class="comment">#The device dictionary may not be up to date. Need to update and try again.</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                                            <span class="comment">#If the device is still not found after first try, move on.</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                            update_dev_dict()</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                logger.error(<span class="stringliteral">&#39;Message corrupt. Will not store in data cache.&#39;</span>)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                                logger.error(e)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="keywordflow">except</span> KeyboardInterrupt, k:</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    logger.info(<span class="stringliteral">&quot;Data Cache server shutting down...&quot;</span>)</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">stop</a>()</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                    <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            <span class="comment">#server_sock.close()</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            <span class="comment">#os.remove(self.socket_file)</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            <span class="comment">#break</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">if</span> os.path.exists(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>): <span class="comment">#checking for the file for a smooth shutdown</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            server_sock.close()</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            os.remove(self.<a class="code" href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">socket_file</a>)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">  300</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">stop</a>(self):</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        stop_process = <span class="keyword">True</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">DC_flush</a>()</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        logger.info(<span class="stringliteral">&quot;DC has been flushed. Process will stop now.&quot;</span>)</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        sys.exit(0)</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment">#try:</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">#    logger.debug(&#39;Flushing data cache....&#39;)</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="comment">#    self.external_flush()</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="comment">#The data cache needs time to flush the messages before stopping the process</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="comment">#time.sleep(5)</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="comment">#Daemon.stop(self)</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="comment">#except Exception as e:</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="comment">#   logger.error(e)</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">#            This function is called to force a flush of the data cache from an external source (i.e. before a system reboot).</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="comment">#            It connects to the server socket of the data cache to request a flush.</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#ae623ba723c9082e00aa3db13d8807d7f">  320</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#ae623ba723c9082e00aa3db13d8807d7f">external_flush</a>(self):</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;         <span class="comment">#connect to DC and send &#39;Flush&#39;</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keywordflow">if</span> os.path.exists(self.socket_file):</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            client_sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                client_sock.connect(self.socket_file)</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                client_sock.sendall(<span class="stringliteral">&#39;Flush&#39;</span>)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                client_sock.close()</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                logger.error(e)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                client_sock.close()</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            logger.debug(<span class="stringliteral">&quot;Sent flush command.&quot;</span>)</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            logger.debug(<span class="stringliteral">&#39;Data cache running?&#39;</span>)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="comment">## @brief             Function that pushes outgoing messages into the outgoing buffer.</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">#            :param int dev: Specifies the device location in the matrix.</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="comment">#            :param int msg_p: Specifies the message priority location in the matrix</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="comment">#            :param int self.msg_counter: Keeps track of the number of total messags currently being stored in the buffers.</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="comment">#            :param int flush: Value indicating if the data cache needs to flush the buffers into files.</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a841f2c94321049f5743d7b9627dc6a2a">  344</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a841f2c94321049f5743d7b9627dc6a2a">outgoing_push</a>(self,dev, msg_p, msg):</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        logger.debug(<span class="stringliteral">&quot;outgoing_push: dev=%d msg_p=%d&quot;</span> % (dev, msg_p))</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="comment">#If the msg counter is greater than or equal to the available memory, flush the outgoing queues into a file</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a>&gt;= AVAILABLE_MEM:</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <span class="comment">#Calls the data cache flush method and passes in the neccessary params</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            logger.debug(<span class="stringliteral">&quot;(outgoing_push) flush because of self.msg_counter&gt;= AVAILABLE_MEM&quot;</span>)</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            self.<a class="code" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">DC_flush</a>() <span class="comment">#Flushes all messages into a file</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> = 0 <span class="comment">#resets the message counter after all buffers have been saved to a file</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="comment">#Increments the self.msg_counter by 1 each time a message is pushed into the data cache</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> += 1</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        logger.debug(<span class="stringliteral">&quot;self.msg_counter: &quot;</span>+str(self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a>))</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            <span class="comment">#pushes the message into the queue at the specified location in the matrix</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            self.<a class="code" href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">outgoing_bffr</a>[(dev - 1)][(msg_p - 1)].put(msg)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            <span class="comment">#adds the queue to the list of available queues</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                self.outgoing_available_queues.index((dev, msg_p)) <span class="comment">#throws an error if this is not already in the list</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                self.outgoing_available_queues.append((dev, msg_p)) <span class="comment">#prevents duplicates</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            logger.error(<span class="stringliteral">&#39;Outgoing push unable to store in data cache...&#39;</span>) <span class="comment">#TODO Should an error message be sent back to the recipient?</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="comment">## @brief             Function that pushes incoming messages to the incoming buffer.</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">#            :param int dev: Specifies the device location in the matrix.</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="comment">#            :param int msg_p: Specifies the message priority location in the matrix</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="comment">#            :param int self.msg_counter: Keeps track of total messages in the data cache.</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="comment">#            :param int flush: Value indicating if the data cache needs to flush the buffers into files.</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a65d6cda8ffbc13098cfda3b1046d38cc">  377</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a65d6cda8ffbc13098cfda3b1046d38cc">incoming_push</a>(self,device, msg_p, msg):</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="comment">#print &#39;msg counter: &#39;,self.msg_counter</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="comment">#print &#39;available mem: &#39;, AVAILABLE_MEM</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="comment">#if the msg counter is greater than or equal to the available memory, flush the buffers into files</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> &gt;= AVAILABLE_MEM:</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <span class="comment">#Calls the data cache flush method</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            logger.debug(<span class="stringliteral">&quot;(incoming_push) flush because of (self.msg_counter &gt;= AVAILABLE_MEM)&quot;</span>)</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            self.<a class="code" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">DC_flush</a>()</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> = 0 <span class="comment">#resets the message counter after all buffers have been saved to a file</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">#increments the counter by 1 each time a message is put into the buffer</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> += 1</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="comment">#pushes the message into the queue at the specified location in the matrix</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">incoming_bffr</a>[device - 1][msg_p - 1].put(msg)</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="comment">#adds the queue to the list of available queues</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            self.incoming_available_queues.index(device) <span class="comment">#checks if the device is already in the list #TODO improve this</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            self.incoming_available_queues.append(device) <span class="comment">#adds it to the list if it is not already there</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="comment">## @brief             Function that retrieves and removes outgoing messages from the outgoing buffer. Retrieves the highest priority messages first. Highest priority messages are determined based on message priority and device priority.</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="comment">#            :param int self.msg_counter: Keeps track of total messages in the data cache.</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">#            :rtype string: Returns a packed message or &#39;False&#39; if no messages are available.</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a4802f5d86a8b865bd8523cff8d14bb21">  406</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a4802f5d86a8b865bd8523cff8d14bb21">outgoing_pull</a>(self):</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        <span class="comment">#TODO implement fairness, avoid starvation</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="comment">#TODO might want to find a better way to remove empty queues from list</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="comment">#continues until a message is sent.</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="comment">#Neccessary to check for empty queues whose index has not yet been removed from the list or files whose messages have all been read and sent</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">#while True:</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="comment">#are there outgoing messages stored as files?</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="comment">#if so, those need to be sent to the cloud first without needing to load all messages from the file and taking up too much RAM</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">#so, send the messages one by one using a file generator object.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="comment">#when all messages have been read from file and sent to cloud, close and delete that file from the directory.</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        outgoing_msg_files = glob(<span class="stringliteral">&#39;/var/dc/outgoing_msgs/*&#39;</span>)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordflow">if</span> len(outgoing_msg_files) &gt; 0 <span class="keywordflow">and</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> == 0: <span class="comment">#prevents the flush from pulling messages from files</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            logger.debug(<span class="stringliteral">&#39;Getting messages from /var/dc/outgoing_msgs/&#39;</span>)</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            <span class="comment">#is there a file generator object already stored as the current file?</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">outgoing_cur_file</a> == <span class="stringliteral">&#39;&#39;</span>:</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                <span class="comment">#print &#39;cur_file is empty string.&#39;</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                <span class="comment">#set the first file in the outgoing_stored directory as the current file generator object</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                logger.debug(<span class="stringliteral">&#39;opening file %s&#39;</span> % (outgoing_msg_files[0]))</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                self.<a class="code" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">outgoing_cur_file</a> = open(outgoing_msg_files[0])</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                <span class="comment">#print &#39;opened file&#39;</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    <span class="comment">#print &#39;trying to read from file&#39;</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                    msg = self.outgoing_cur_file.next().strip() <span class="comment">#reads the next message in file, strips the \n</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                    <span class="comment">#print &#39;returning msg&#39;</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                    <span class="keywordflow">return</span> msg</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                    self.outgoing_cur_file.close() <span class="comment">#close the file if stop iterator error occurs</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                    <span class="keywordflow">if</span> os.path.isfile(self.outgoing_cur_file.name): <span class="comment">#make sure the file exists</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                        os.remove(self.outgoing_cur_file.name)<span class="comment">#delete the file</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">outgoing_cur_file</a> = <span class="stringliteral">&#39;&#39;</span> <span class="comment">#reset to empty string</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                logger.debug(<span class="stringliteral">&#39;reading from exsiting file handle (data from /var/dc/outgoing_msgs/*)&#39;</span>)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                    msg = self.outgoing_cur_file.next().strip() <span class="comment">#reads the next message in file, strips the \n</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                    <span class="keywordflow">return</span> msg</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                    self.outgoing_cur_file.close() <span class="comment">#close the file if stop iterator error occurs</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                    <span class="keywordflow">if</span> os.path.isfile(self.outgoing_cur_file.name): <span class="comment">#make sure the file exists</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                        os.remove(self.outgoing_cur_file.name) <span class="comment">#delete the file</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">outgoing_cur_file</a> = <span class="stringliteral">&#39;&#39;</span> <span class="comment">#reset to empty string</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="comment">#If there are no messages stored as files, pull messages from the queues</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            logger.debug(<span class="stringliteral">&#39;trying to get message from queue...&#39;</span>)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            <span class="comment">#Are there any messages available?</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            <span class="keywordflow">if</span> len(self.<a class="code" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">outgoing_available_queues</a>) == 0: <span class="comment">#no messages available</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <span class="comment">#logger.debug(&#39;No messages available.&#39;)</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="comment">#Calls the function that returns the highest priority tuple in the list</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                cache_index = self.<a class="code" href="classData__Cache_1_1DataCache.html#ad1653357189946a4e2c7791102fcecaa">get_priority</a>() <span class="comment">#returns the index of the highest priority queue in fifo buffer</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                sender_p, msg_p = cache_index</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                logger.debug(<span class="stringliteral">&quot;sender_p: %s msg_p: %s&quot;</span> % (str(sender_p), str(msg_p) ))</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                current_q = self.<a class="code" href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">outgoing_bffr</a>[sender_p - 1][msg_p - 1]</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="comment">#checks if the queue is empty</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="keywordflow">if</span> current_q.empty():</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                    logger.debug(<span class="stringliteral">&quot;current_q.empty&quot;</span>)</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                    <span class="comment">#removes it from the list of available queues</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                    self.outgoing_available_queues.remove(cache_index)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                    logger.debug(<span class="stringliteral">&quot;getting message from current_q, size: %d&quot;</span> % (current_q.qsize()))</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> -= 1 <span class="comment">#decrements the counter by 1</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                    <span class="keywordflow">return</span> current_q.get()</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">## @brief             Function that retrieves and removes incoming messages from the incoming buffer. Searches through all of the message priority queues for the specified device to return the highest priority message first.</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="comment">#            :param int dev: Specifies the device location in the matrix.</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a1a83f7f61f7bee466fd265ef574823d3">  485</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a1a83f7f61f7bee466fd265ef574823d3">incoming_pull</a>(self,dev):</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="comment">#continues until something is returned.</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">#Neccessary to check for files whose messages have all been read and sent but have not yet been deleted</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <span class="comment">#are there incoming messages stored as files for the specified dev?</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="comment">#if so, those need to be sent first without needing to load all messages from the file and taking up too much RAM</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            <span class="comment">#so, send the messages one by one using a file generator object.</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="comment">#when all messages have been read from file and sent to device, close and delete that file from the directory.</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            incoming_msg_files = glob(<span class="stringliteral">&#39;/var/dc/incoming_msgs/&#39;</span> + str(dev) + <span class="stringliteral">&#39;/*&#39;</span>)</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            <span class="keywordflow">if</span> len(incoming_msg_files) &gt; 0 <span class="keywordflow">and</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> == 0: <span class="comment">#only pulls messages from file if DC is not flushing</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                <span class="comment">#is there a file generator object already stored as the current file?</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev - 1] == <span class="stringliteral">&#39;&#39;</span>:</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                    <span class="comment">#set the first file in the incoming_stored/dev directory as the current file generator object</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                    self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1] = open(incoming_msg_files[0])</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                        msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].next().strip() <span class="comment">#reads the next message in file, strips the \n</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                        <span class="keywordflow">return</span> msg</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                    <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                        self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].close() <span class="comment">#close the file if stop iterator error occurs</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                        <span class="keywordflow">if</span> os.path.isfile(self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].name): <span class="comment">#make sure the file exists</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                            os.remove(self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].name)<span class="comment">#delete the file</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                        self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1] = <span class="stringliteral">&#39;&#39;</span> <span class="comment">#reset to empty string</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                        msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].next().strip() <span class="comment">#reads the next message in file, strips the \n</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                        <span class="keywordflow">return</span> msg</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                    <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                        self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].close() <span class="comment">#close the file if stop iterator error occurs</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                        <span class="keywordflow">if</span> os.path.isfile(self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].name): <span class="comment">#make sure the file exists</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                            os.remove(self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1].name)<span class="comment">#delete the file</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                        self.<a class="code" href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">incoming_cur_file</a>[dev -1] = <span class="stringliteral">&#39;&#39;</span> <span class="comment">#reset to empty string</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            <span class="comment">#if no messages are stored in files, check for messages in queues</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                    <span class="comment">#checks to see if there are messages for the device</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                    <span class="comment">#results in an error if that dev isn&#39;t in the list</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    self.incoming_available_queues.index(dev) <span class="comment">#TODO Probably need a better way to do this</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                    msg = <span class="stringliteral">&#39;False&#39;</span> <span class="comment">#default</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(4,-1,-1): <span class="comment"># loop to search for messages starting with highest priority</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                        <span class="keywordflow">if</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">incoming_bffr</a>[dev - 1][i].empty(): <span class="comment">#checks for an empty queue</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                            <span class="keywordflow">pass</span> <span class="comment">#do nothing</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                            <span class="comment">#decrements the counter by 1 each time a message is removed</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                            self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a> -= 1</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                            msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">incoming_bffr</a>[dev - 1][i].get() <span class="comment">#sets to message and breaks the loop</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                            <span class="keywordflow">break</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                    <span class="comment">#if the message is still false (i.e. no messages are actually available for that device), remove dev from list</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                    <span class="keywordflow">if</span> msg == <span class="stringliteral">&#39;False&#39;</span>:</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                        self.incoming_available_queues.remove(dev)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                    <span class="keywordflow">return</span> msg</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                <span class="keywordflow">except</span>:</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                    <span class="comment">#returns false if no messages are available</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                    <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="comment">#            Function that temporary closes the Data Cache server to write the outgoing and incoming queues into files.</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="comment">#            This function is called when the data cache reaches its maximum number of messages it can store in RAM or before the NC is shutdown by WagMan</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">  549</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">DC_flush</a>(self):</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> = 1</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        cur_date = str(datetime.datetime.now().strftime(<span class="stringliteral">&#39;%Y%m%d%H:%M:%S&#39;</span>))</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        logger.debug(<span class="stringliteral">&#39;Flushing at &#39;</span> + cur_date)</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            filename = <span class="stringliteral">&#39;/var/dc/outgoing_msgs/&#39;</span> + cur_date <span class="comment">#file name is date of flush</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            f = open(filename, <span class="stringliteral">&#39;w&#39;</span>)</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            logger.debug(<span class="stringliteral">&#39;Flushing outgoing&#39;</span>)</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            <span class="keywordflow">while</span> <span class="keyword">True</span>: <span class="comment">#write all outgoing messages to outgoing file</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                <span class="comment">#messages are written to file with highest priority at the top</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a4802f5d86a8b865bd8523cff8d14bb21">outgoing_pull</a>() <span class="comment">#returns false when all queues are empty</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> msg: <span class="comment">#no more messages available. break and close file</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                    <span class="keywordflow">break</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                    <span class="comment">#write the message to the file</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                    f.write(msg + <span class="stringliteral">&#39;\n&#39;</span>)</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;            f.close()</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;            logger.debug(<span class="stringliteral">&#39;Flushing incoming&#39;</span>)</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> PRIORITY_ORDER: <span class="comment">#write all incoming messages to file</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                <span class="comment">#each device has a separate folder. This prevents needing to loop through all messages or all files to find messages for only the connected devices.</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                <span class="comment">#TODO Change this to /etc/waggle/dc/outgoing or something</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                pathname = <span class="stringliteral">&#39;/var/dc/incoming_msgs/&#39;</span> + str(i) + <span class="stringliteral">&#39;/&#39;</span> <span class="comment">#set the path</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                logger.debug(<span class="stringliteral">&#39;pathname: &#39;</span>+ pathname)</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(pathname): <span class="comment">#make sure the directory exists</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                    os.makedirs(pathname)</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                filename = pathname + cur_date <span class="comment">#set the file name to the date and time of flush</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                f = open(filename, <span class="stringliteral">&#39;w&#39;</span>)</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                    <span class="comment">#for each device, messages are stored with highest priority on the top of the file</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                    msg = self.<a class="code" href="classData__Cache_1_1DataCache.html#a1a83f7f61f7bee466fd265ef574823d3">incoming_pull</a>(i)</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> msg:  <span class="comment">#No more messages available. break and close file.</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                        f.close()</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                        <span class="keywordflow">break</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                    <span class="keywordflow">elif</span> msg ==<span class="stringliteral">&#39;None&#39;</span>: <span class="comment">#No messages currently available for device. Close and remove file</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                        f.close()</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                        <span class="keywordflow">if</span> os.path.isfile(f.name):</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                            os.remove(f.name)</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                        <span class="keywordflow">break</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                        <span class="comment">#write the message to the file</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                        f.write(msg + <span class="stringliteral">&#39;\n&#39;</span>)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> stop_process:</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                self.<a class="code" href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">flush</a> = 0 <span class="comment">#restart server</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                logger.debug(<span class="stringliteral">&#39;Data cache restarted&#39;</span>)</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            logger.error(e)</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="comment">## @brief             Function that returns the number of messages currently stored in the data cache.</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#a62851e3db24139e29cfb20433aaadf9b">  603</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#a62851e3db24139e29cfb20433aaadf9b">get_status</a>(self):</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="comment">#TODO This doesn&#39;t work. Needs to be a unix socket to communicate with the data cache as it is running.</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="comment">#TODO Socket needs to send a status request message and data cache needs to respond with Data_cache.self.msg_counter</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="keywordflow">return</span> self.<a class="code" href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">msg_counter</a></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">## @brief             Generates a buffer, which is a matrix containing queues.</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="comment">#            :param int length: Specifies the number of rows in the matrix</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="comment">#            :rtype list buff: The matrix containing queues</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#ab3eba25936f842529523447d070aa2e2">  616</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#ab3eba25936f842529523447d070aa2e2">make_bffr</a>(self, length):</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        buff = []</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="comment">#device priority</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(length):</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            buff_in = []</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(5): <span class="comment">#Assuming that messages can only have priority 1-5</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                buff_in.append(Queue())</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            buff.append(buff_in)</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <span class="keywordflow">return</span> buff</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">## @brief             Function that finds the highest priority queue in the list. Highest priority is determined by comparing message priority and device priority.</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">#            :rtype: tuple(device_priority, message_priority) or string &#39;False&#39;</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="comment">#</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno"><a class="line" href="classData__Cache_1_1DataCache.html#ad1653357189946a4e2c7791102fcecaa">  632</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classData__Cache_1_1DataCache.html#ad1653357189946a4e2c7791102fcecaa">get_priority</a>(self):</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="comment">#returns False if there are no messages available</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="keywordflow">if</span> len(self.<a class="code" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">outgoing_available_queues</a>) == 0:</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            <span class="keywordflow">return</span> <span class="stringliteral">&#39;False&#39;</span></div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            highest_de_p = PRIORITY_ORDER[(len(PRIORITY_ORDER)-1)] <span class="comment">#sets it to the lowest priority as default</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            highest_msg_p = 0 <span class="comment">#default</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">outgoing_available_queues</a>)): <span class="comment">#i has to be an int</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                device_p, msg_p = self.<a class="code" href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">outgoing_available_queues</a>[i]</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                <span class="keywordflow">if</span> msg_p &gt;= highest_msg_p: <span class="comment">#if the msg_p is higher or equal to the current highest</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                    <span class="keywordflow">if</span> PRIORITY_ORDER.index(device_p) &lt; PRIORITY_ORDER.index(highest_de_p): <span class="comment">#and the device_p is higher</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                        highest_de_p = device_p <span class="comment">#then that element becomes the new highest_p</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                        highest_msg_p = msg_p</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                    <span class="keywordflow">else</span>: <span class="comment">#but, if the device_p is lower, the element should still be the new highest_p that gets checked next</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                        highest_de_p = device_p <span class="comment">#then that element becomes the new highest_p</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                        highest_msg_p = msg_p</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <span class="keywordflow">return</span> (highest_de_p, highest_msg_p)</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div>
<div class="line"><a name="l00655"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#ae84ec9b6b630bb3bebaa8bb13ecf7d57">  655</a></span>&#160;    parser = argparse.ArgumentParser()</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    parser.add_argument(<span class="stringliteral">&#39;--logging&#39;</span>, dest=<span class="stringliteral">&#39;enable_logging&#39;</span>, help=<span class="stringliteral">&#39;write to log files instead of stdout&#39;</span>, action=<span class="stringliteral">&#39;store_true&#39;</span>)</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    parser.add_argument(<span class="stringliteral">&#39;--force&#39;</span>, dest=<span class="stringliteral">&#39;force&#39;</span>, help=<span class="stringliteral">&#39;kill other processes and start&#39;</span>, action=<span class="stringliteral">&#39;store_true&#39;</span>)</div>
<div class="line"><a name="l00658"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a259a8d130b109b60729498088c4214c4">  658</a></span>&#160;    args = parser.parse_args()</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">if</span> args.enable_logging:</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="comment"># 5 times 10MB</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        sys.stdout.write(<span class="stringliteral">&#39;logging to &#39;</span>+LOG_FILENAME+<span class="stringliteral">&#39;\n&#39;</span>)</div>
<div class="line"><a name="l00664"></a><span class="lineno"><a class="line" href="namespaceData__Cache.html#a108b43d114ebf0252e432721b8dc9055">  664</a></span>&#160;        log_dir = os.path.dirname(LOG_FILENAME)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isdir(log_dir):</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            os.makedirs(log_dir)</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=1485760, backupCount=5)</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        handler.setFormatter(formatter)</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        root_logger.handlers = []</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        root_logger.addHandler(handler)</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        with PidFile(pid_file, force=args.force, name=os.path.basename(__file__) ):</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            dc = <a class="code" href="classData__Cache_1_1DataCache.html">DataCache</a>()</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            dc.run()</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">except</span> AlreadyRunning <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        logger.error(str(e))</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        logger.error(<span class="stringliteral">&quot;Please use supervisorctl to start and stop this script.&quot;</span>)</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">except</span> KeyboardInterrupt, k:</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="comment">#terminate the external communication processes</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        <span class="comment">#for name, subhash in name2func.iteritems():</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="comment">#    logger.info( &#39;(KeyboardInterrupt) shutting down &#39; + name)</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="comment">#    name2process[name].terminate()</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        logger.info(<span class="stringliteral">&#39;exiting...&#39;</span>)</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        logger.error(<span class="stringliteral">&quot;Error (%s): %s&quot;</span> % ( str(type(e)), str(e)))</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="comment">#lists keeping track of which queues currently have messages stored in them</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a62851e3db24139e29cfb20433aaadf9b"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a62851e3db24139e29cfb20433aaadf9b">Data_Cache.DataCache.get_status</a></div><div class="ttdeci">def get_status</div><div class="ttdoc">Function that returns the number of messages currently stored in the data cache. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00603">Data_Cache.py:603</a></div></div>
<div class="ttc" id="namespaceData__Cache_html_a8c7eb271c63236a96891baf73a81a4b4"><div class="ttname"><a href="namespaceData__Cache.html#a8c7eb271c63236a96891baf73a81a4b4">Data_Cache.signal_term_handler</a></div><div class="ttdeci">def signal_term_handler</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00059">Data_Cache.py:59</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_add69205279467ec6d9ac20fc5c36b9c2"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#add69205279467ec6d9ac20fc5c36b9c2">Data_Cache.DataCache.outgoing_cur_file</a></div><div class="ttdeci">outgoing_cur_file</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00094">Data_Cache.py:94</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a0974d48dc0716d1ecaf928dc3481e077"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a0974d48dc0716d1ecaf928dc3481e077">Data_Cache.DataCache.flush</a></div><div class="ttdeci">flush</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00091">Data_Cache.py:91</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_abbaab48d9fe727111a2835b2c71fad35"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#abbaab48d9fe727111a2835b2c71fad35">Data_Cache.DataCache.run</a></div><div class="ttdeci">def run</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00101">Data_Cache.py:101</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a3bcf3db7c1f52b36b1cef8d14038980f"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a3bcf3db7c1f52b36b1cef8d14038980f">Data_Cache.DataCache.stop</a></div><div class="ttdeci">def stop</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00300">Data_Cache.py:300</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a841f2c94321049f5743d7b9627dc6a2a"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a841f2c94321049f5743d7b9627dc6a2a">Data_Cache.DataCache.outgoing_push</a></div><div class="ttdeci">def outgoing_push</div><div class="ttdoc">Function that pushes outgoing messages into the outgoing buffer. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00344">Data_Cache.py:344</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_ae74960aa847ac98acf32c596e485511d"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#ae74960aa847ac98acf32c596e485511d">Data_Cache.DataCache.socket_file</a></div><div class="ttdeci">socket_file</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00085">Data_Cache.py:85</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html"><div class="ttname"><a href="classData__Cache_1_1DataCache.html">Data_Cache.DataCache</a></div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00081">Data_Cache.py:81</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a19ba48589527826ed93c52f09150c118"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a19ba48589527826ed93c52f09150c118">Data_Cache.DataCache.msg_counter</a></div><div class="ttdeci">msg_counter</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00092">Data_Cache.py:92</a></div></div>
<div class="ttc" id="namespacemsg__handler_html"><div class="ttname"><a href="namespacemsg__handler.html">msg_handler</a></div><div class="ttdef"><b>Definition:</b> <a href="msg__handler_8py_source.html#l00001">msg_handler.py:1</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_aedd2bb179af3b189e4ecf0636e680f61"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#aedd2bb179af3b189e4ecf0636e680f61">Data_Cache.DataCache.__init__</a></div><div class="ttdeci">def __init__</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00082">Data_Cache.py:82</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a1a83f7f61f7bee466fd265ef574823d3"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a1a83f7f61f7bee466fd265ef574823d3">Data_Cache.DataCache.incoming_pull</a></div><div class="ttdeci">def incoming_pull</div><div class="ttdoc">Function that retrieves and removes incoming messages from the incoming buffer. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00485">Data_Cache.py:485</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a3f6b6ee7a661279a0cdb798ddcd526b5"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a3f6b6ee7a661279a0cdb798ddcd526b5">Data_Cache.DataCache.outgoing_available_queues</a></div><div class="ttdeci">outgoing_available_queues</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00098">Data_Cache.py:98</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_ae623ba723c9082e00aa3db13d8807d7f"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#ae623ba723c9082e00aa3db13d8807d7f">Data_Cache.DataCache.external_flush</a></div><div class="ttdeci">def external_flush</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00320">Data_Cache.py:320</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a9547aa0233dba02012479e490e1ee67d"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a9547aa0233dba02012479e490e1ee67d">Data_Cache.DataCache.DC_flush</a></div><div class="ttdeci">def DC_flush</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00549">Data_Cache.py:549</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_aff3edf83663964b2f06f1054cf20d2f9"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#aff3edf83663964b2f06f1054cf20d2f9">Data_Cache.DataCache.outgoing_bffr</a></div><div class="ttdeci">outgoing_bffr</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00089">Data_Cache.py:89</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a4802f5d86a8b865bd8523cff8d14bb21"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a4802f5d86a8b865bd8523cff8d14bb21">Data_Cache.DataCache.outgoing_pull</a></div><div class="ttdeci">def outgoing_pull</div><div class="ttdoc">Function that retrieves and removes outgoing messages from the outgoing buffer. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00406">Data_Cache.py:406</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a55883383b1da8ab7f04b3467583d5fe0"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a55883383b1da8ab7f04b3467583d5fe0">Data_Cache.DataCache.incoming_bffr</a></div><div class="ttdeci">incoming_bffr</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00087">Data_Cache.py:87</a></div></div>
<div class="ttc" id="namespacewaggle__protocol_1_1protocol_1_1PacketHandler_html"><div class="ttname"><a href="namespacewaggle__protocol_1_1protocol_1_1PacketHandler.html">PacketHandler</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a8061a8b3a8db64ba0bfb88274d8d259e"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a8061a8b3a8db64ba0bfb88274d8d259e">Data_Cache.DataCache.incoming_available_queues</a></div><div class="ttdeci">incoming_available_queues</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00099">Data_Cache.py:99</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a1fccebee1474dd22dcd50d7ef2598c8e"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a1fccebee1474dd22dcd50d7ef2598c8e">Data_Cache.DataCache.incoming_cur_file</a></div><div class="ttdeci">incoming_cur_file</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00096">Data_Cache.py:96</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_ad1653357189946a4e2c7791102fcecaa"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#ad1653357189946a4e2c7791102fcecaa">Data_Cache.DataCache.get_priority</a></div><div class="ttdeci">def get_priority</div><div class="ttdoc">Function that finds the highest priority queue in the list. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00632">Data_Cache.py:632</a></div></div>
<div class="ttc" id="namespaceData__Cache_html_ac38c6d21a594205fe16a2de3c86f72fc"><div class="ttname"><a href="namespaceData__Cache.html#ac38c6d21a594205fe16a2de3c86f72fc">Data_Cache.signal_info_handler</a></div><div class="ttdeci">def signal_info_handler</div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00069">Data_Cache.py:69</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_a65d6cda8ffbc13098cfda3b1046d38cc"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#a65d6cda8ffbc13098cfda3b1046d38cc">Data_Cache.DataCache.incoming_push</a></div><div class="ttdeci">def incoming_push</div><div class="ttdoc">Function that pushes incoming messages to the incoming buffer. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00377">Data_Cache.py:377</a></div></div>
<div class="ttc" id="classData__Cache_1_1DataCache_html_ab3eba25936f842529523447d070aa2e2"><div class="ttname"><a href="classData__Cache_1_1DataCache.html#ab3eba25936f842529523447d070aa2e2">Data_Cache.DataCache.make_bffr</a></div><div class="ttdeci">def make_bffr</div><div class="ttdoc">Generates a buffer, which is a matrix containing queues. </div><div class="ttdef"><b>Definition:</b> <a href="Data__Cache_8py_source.html#l00616">Data_Cache.py:616</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_8d942f81ec41e98e4e4e046ada6f8c6f.html">nodecontroller</a></li><li class="navelem"><a class="el" href="dir_3e15fdad7c00441ddc8a00f54c2a55b7.html">nc-wag-os</a></li><li class="navelem"><a class="el" href="dir_14dd35bcf1aa39209640c373d6ff4c6f.html">waggled</a></li><li class="navelem"><a class="el" href="dir_56f6390bbdf544a26cae9a9ca13d0237.html">DataCache</a></li><li class="navelem"><a class="el" href="Data__Cache_8py.html">Data_Cache.py</a></li>
    <li class="footer">Generated on Tue Jun 14 2016 11:01:45 for Waggle by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
