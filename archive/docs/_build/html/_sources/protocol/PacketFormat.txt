Waggle Packet Format
====================

Waggle currently uses Waggle Communication Protocol v0.3, which the modules in the Waggle Protocol directory handle.

A waggle packet is formed of three main components:
   - A 40-byte long header
   - A body no longer than 1KB
   - A 4-byte footer

Put together, these components form the structure in the following diagram:

.. table:: Packet format
   :widths: 1 1 1 1 
   :column-alignment: center

   +-------------------------+-------------------------+-------------------------+-------------------------+
   |Protocol Version (1B)    |        Flags (1B)       |            Length of Message Body (2B)            |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                          Message Timestamp (4B)                                       |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   | Message Major Type (1B) | Message Minor Type (1B) |               Extended Header (2B)                |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                         Sender's Unique ID (8B)                                       |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                         Sender's Unique ID (cont)                                     |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                       Receiver's Unique ID (8B)                                       |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                       Receiver's Unique ID (cont)                                     |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |             Send Session Number (2B)              |              Response Session Number (2B)         |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |             Send Sequence (3B)                                              |   Respond Sequence (3B) |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |          Respond Sequence (cont)                  |        CRC-16 of the header data (2B)             |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                                                                                       |
   |                                                                                                       |
   |                                      Message payload (1024B maximum)                                  |
   |                                                                                                       |
   |                                                                                                       |
   +-------------------------+-------------------------+-------------------------+-------------------------+
   |                                      CRC-32 of the message payload (4B)                               |
   +-------------------------+-------------------------+-------------------------+-------------------------+